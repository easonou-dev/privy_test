# Token 余额查询测试说明

## 功能描述

新增了查询用户持有 Yes/No token 余额的功能，集成到现有的 CTC 测试套件中。

## 测试步骤

### 完整测试流程

1. **初始化合约** - 设置 CTC 和 Order 合约的全局状态
2. **创建市场** - 创建预测市场，设置 2 分钟内盘期
3. **内盘投注** - 在内盘期进行 Yes/No 投注，建立初始流动性
4. **触发 Pump** - 内盘期结束后触发，转换市场状态到外盘
5. **查询价格** - 查询 LMSR 当前价格
6. **LMSR 买入** - 使用 LMSR 机制买入 Yes/No 代币
7. **🆕 查询 Token 余额** - 查看用户持有的 Yes/No token 数量（新功能）
8. **LMSR 卖出** - 卖出持有的代币获得收益

### Token 余额查询功能特点

#### 查询方法

代码中实现了多种查询方法的降级处理：

1. **主要方法**: 使用`predictionMarket.getUserAmount()`
2. **备用方法**: 通过 SPL Token 直接查询关联 token 账户
3. **兜底方法**: 提供模拟数据用于测试 UI

#### 显示信息

- 用户钱包地址
- 市场 ID 和问题 ID
- Yes Token 余额（6 位小数精度）
- No Token 余额（6 位小数精度）
- 总 token 数量
- 查询使用的方法
- 详细的说明和开发提示

#### 错误处理

- 网络连接问题
- SDK 接口调用错误
- Token 账户未初始化
- Token mint 地址获取失败
- 用户未持有 token 的情况

## 代码实现

### 核心函数

```typescript
const testGetUserTokenBalance = async (isGasless: boolean) => {
  // 1. 验证前置条件（市场和问题已创建）
  // 2. 创建钱包适配器
  // 3. 多种方法查询token余额
  // 4. 格式化显示结果
  // 5. 错误处理和用户提示
};
```

### UI 集成

- 添加到现有的标签页导航中（第 8 步）
- 提供 Gasless 和外部钱包两种模式
- 实时显示查询结果和错误信息
- 包含详细的使用说明和开发提示

## 使用场景

### 用户场景

1. **投资追踪**: 用户可以随时查看自己持有的 Yes/No token 数量
2. **收益计算**: 了解当前持仓价值，计算潜在收益
3. **交易决策**: 基于当前持仓情况决定是否进行更多交易

### 开发场景

1. **功能测试**: 验证 LMSR 买入后 token 是否正确分配
2. **余额验证**: 确保 token 转账和交易的准确性
3. **UI 调试**: 测试余额显示的正确性和用户体验

## 技术细节

### Token 精度

- 使用 6 位小数精度（1,000,000 = 1 token）
- 支持原始值和格式化值的双重显示
- 自动计算总持仓数量

### 兼容性

- 支持 Gasless 模式（嵌入式钱包）
- 支持外部钱包模式（Phantom 等）
- 兼容不同的 SDK 接口版本

### 扩展性

- 可以轻松添加更多查询方法
- 支持不同的 token 类型和市场
- 预留了 SDK 接口调整的空间

## 注意事项

1. **SDK 依赖**: 需要确保 SDK 中有相应的 token 查询接口
2. **网络延迟**: token 余额更新可能有延迟，建议在交易后等待几秒再查询
3. **账户初始化**: 首次持有 token 时可能需要初始化关联 token 账户
4. **错误处理**: 代码包含了完善的错误处理和用户提示

## 后续优化

1. **自动刷新**: 可以添加定时自动刷新功能
2. **历史记录**: 记录余额变化历史
3. **图表显示**: 用图表展示持仓分布
4. **实时更新**: 监听区块链事件实时更新余额
